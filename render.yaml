# https://render.com/docs/blueprint-spec
#
# TRICKY: We can’t include the environment group here
#         if we want to share it between blueprint instances
# envVarGroups:
# - name: dollyskettle-settings
#   envVars:
#     - key: GITHUB_USER_EMAIL
#       sync: false
#     - key: GITHUB_USER_NAME
#       sync: false
#     - key: GITHUB_REPOSITORY
#       sync: false
#
#   NOTE: This is for documentation purposes and isn’t supported by Render
#   secretFiles:
#     - fileName: .htpasswd
#       sync: false
#     - fileName: id_ed25519
#       sync: false
#     - fileName: id_ed25519.pub
#       sync: false
#     - fileName: known_hosts
#       sync: false
#
# - name: dollyskettle-replica
#   envVars:
#     - key: WORDPRESS_ENVIRONMENT
#       value: replica
#     - key: BACKUP_STATUS_DEPLOY_HOOK
#       sync: false
#     - key: BACKUP_STATUS_API_TOKEN
#       sync: false
#     - key: BACKUP_STATUS_SERVICE_ID
#       sync: false
#
# - name: dollyskettle-publish
#   envVars:
#     - key: WORDPRESS_ENVIRONMENT
#       value: publish
#     - key: GITHUB_USER_EMAIL
#       sync: false
#     - key: GITHUB_USER_NAME
#       sync: false
#     - key: GITHUB_REPOSITORY
#       sync: false
#     - key: GITHUB_REPOSITORY_WORDPRESS
#       sync: false
#     - key: NETLIFY_SITE_ID
#       sync: false
#     - key: NETLIFY_AUTH_TOKEN
#       sync: false
#     - key: NETLIFY_DEPLOY_HOOK
#       sync: false
#     - key: AUTHORIZATION_HEADER_VALUE
#       sync: false
#     - key: PUBLISH_DEPLOY_HOOK
#       sync: false
#     - key: PUBLISH_API_TOKEN
#       sync: false
#     - key: PUBLISH_SERVICE_ID
#       sync: false
#
# - name: dollyskettle-production
#   envVars:
#     - key: WORDPRESS_ENVIRONMENT
#       value: production
#     - key: BACKUP_STATUS_DEPLOY_HOOK
#       sync: false
#     - key: BACKUP_STATUS_API_TOKEN
#       sync: false
#     - key: BACKUP_STATUS_SERVICE_ID
#       sync: false
#     - key: REPLICA_WORDPRESS_DEPLOY_HOOK
#       sync: false
#     - key: REPLICA_API_TOKEN
#       sync: false
#     - key: REPLICA_MYSQL_SERVICE_ID
#       sync: false
#     - key: REPLICA_WORDPRESS_SERVICE_ID
#       sync: false
#     - key: PRODUCTION_WORDPRESS_SSH_ADDRESS
#       sync: false
#     - key: PRODUCTION_DEPLOY_HOOK
#       sync: false
#     - key: PUBLISH_DEPLOY_HOOK
#       sync: false
#     - key: PUBLISH_API_TOKEN
#       sync: false
#     - key: PUBLISH_SERVICE_ID
#       sync: false
#     - key: REPLICA_URL
#       sync: false
#     - key: REPLICA_URL_AUTHORIZATION_BASIC
#       sync: false
#     - key: PRODUCTION_URL
#       sync: false
#     - key: PRODUCTION_URL_AUTHORIZATION_BASIC
#       sync: false
#
previewsEnabled: false
services:
- type: web
  name: dollyskettle-wordpress
  env: docker
  dockerfilePath: ./apache/Dockerfile
  dockerContext: ./apache
  initialDeployHook: "bash /usr/local/bin/setup.sh"
  autoDeploy: false
  region: oregon
  plan: starter
  disk:
    name: git-wordpress
    mountPath: /var/www/git-wordpress
    sizeGB: 30
  envVars:
  - fromGroup: dollyskettle-settings
  - key: WORDPRESS_DB_HOST
    fromService:
      name: dollyskettle-mysql
      type: pserv
      property: host
  - key: WORDPRESS_DB_NAME
    fromService:
      name: dollyskettle-mysql
      type: pserv
      envVarKey: MYSQL_DATABASE
  - key: WORDPRESS_DB_USER
    fromService:
      name: dollyskettle-mysql
      type: pserv
      envVarKey: MYSQL_USER
  - key: WORDPRESS_DB_PASSWORD
    fromService:
      name: dollyskettle-mysql
      type: pserv
      envVarKey: MYSQL_PASSWORD
- type: pserv
  name: dollyskettle-mysql
  env: docker
  dockerfilePath: ./mysql/Dockerfile
  dockerContext: ./mysql
  autoDeploy: false
  region: oregon
  plan: starter
  disk:
    name: mysql
    mountPath: /var/lib/mysql
    sizeGB: 5
  envVars:
  - key: MYSQL_DATABASE
    value: wordpress
  - key: MYSQL_USER
    value: wordpress
  - key: MYSQL_PASSWORD
    generateValue: true
  - key: MYSQL_ROOT_PASSWORD
    generateValue: true
# A Python cron job that runs at 5 a.m. UTC
- type: cron
  name: dollyskettle-backup
  env: docker
  dockerfilePath: ./backup/Dockerfile
  dockerContext: ./backup
  autoDeploy: true
  # https://render.com/docs/monorepo-support
  buildFilter:
    paths:
      - backup/**
  region: oregon
  # 4:00 am UTC
  schedule: "0 4 * * *"
  envVars:
  - fromGroup: dollyskettle-settings
- type: web
  name: dollyskettle-backup-status
  env: static
  autoDeploy: false
  buildCommand: "bash ./backup/test.sh"
  staticPublishPath: ./backup-test-results
  envVars:
  - fromGroup: dollyskettle-settings
- type: worker
  name: dollyskettle-publish
  env: docker
  dockerfilePath: ./publish/Dockerfile
  dockerContext: ./publish
  initialDeployHook: "bash /usr/local/bin/setup.sh"
  autoDeploy: false
  region: oregon
  plan: starter
  disk:
    name: root
    mountPath: /root
    sizeGB: 70
  envVars:
  # For `netlify lm:install`
  - key: SHELL
    value: /bin/bash
  - key: BASH_SOURCE
    value: /bin/bash
